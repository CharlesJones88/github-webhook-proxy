#!/bin/sh

tmpdir=/tmp/tailscale
mkdir -p $tmpdir
/var/runtime/tailscaled --tun=userspace-networking --socks5-server=localhost:1055 --statedir $tmpdir 2>&1 | tee /tmp/stdout &

i=0
timeout=${TAILSCALE_CONNECT_TIMEOUT:-60}
until /var/runtime/tailscale up --auth-key=${TAILSCALE_AUTHKEY} --hostname=github-webhook --force-reauth
do
  sleep 1
  i=$((i + 1))
  if [ $i -ge $timeout ]; then
    echo "tailscale up failed after $timeout seconds"
    exit 1
  fi
done

echo "tailscale started successfully, starting lambda"
export ALL_PROXY=socks5h://localhost:1055
exec /lambda-entrypoint.sh "$@"
